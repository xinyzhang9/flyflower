<html>
<head>
	<title>flyflower</title>
	<meta charset="utf-8" />
	<link rel="stylesheet" type="text/css" href="basic.css">
	<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
	<script src="https://use.fontawesome.com/b8e7fe9976.js"></script>
</head>
<body>
	<div class = 'container'>
		<div class="header">
	        <h1>飞<span style = 'color:hotpink;'>花</span>令</h1>
	        <p>
	        	作者: <a href="https://github.com/xinyzhang9" target = '_blank'>阳哥</a>
	        </p>
	        <hr class = 'style-two' />
    	</div>
	    <div id = 'mainbox'>
    		<input type = 'text' id = 'userinput'></input>
	    	<button id = 'search'><i class="fa fa-search" aria-hidden="true"></i></button>
	    	<button id = 'refresh'><i class="fa fa-refresh" aria-hidden="true"></i></button>
	    </div>
        <div id = 'res'>
        	<h3 id = 'title'></h3>
        	<p id = 'author'></p>
        	<p id = 'content'></p>
        	<button id = 'show_full'><i class="fa fa-toggle-off" aria-hidden="true"></i></button>
        	<div id = 'full'></div>
        </div>
	</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/5.0.1/Rx.min.js"></script>

<script type="text/javascript">
	var refreshButton = document.getElementById('refresh');
	var userInput = document.getElementById('userinput');
	var searchButton = document.getElementById('search');
	var showButton = document.getElementById('show_full');

	var res_div = document.getElementById('res');
	var title_p = document.getElementById('title');
	var content_p = document.getElementById('content');
	var author_p = document.getElementById('author');
	var full_p = document.getElementById('full');

	var refreshClickStream = Rx.Observable.fromEvent(refreshButton, 'click');
	var searchButtonStream = Rx.Observable.fromEvent(searchButton,'click');

	full_p.style.display = 'none';
	showButton.style.visibility = 'hidden';

	showButton.addEventListener('click',function(){
		if(full_p.style.display == "none"){
			full_p.style.display = "block";
			showButton.innerHTML = '<i class="fa fa-toggle-on" aria-hidden="true"></i>';
		}else{
			full_p.style.display = "none";
			showButton.innerHTML = '<i class="fa fa-toggle-off" aria-hidden="true"></i>';
		}
	})

	Storage.prototype.setObj = function(key, obj) {
	    return this.setItem(key, JSON.stringify(obj))
	}
	Storage.prototype.getObj = function(key) {
	    return JSON.parse(this.getItem(key))
	}

	var res = [];

	function loadJSON(file, callback) {   
	    var xobj = new XMLHttpRequest();
	    xobj.overrideMimeType("application/json");
	    xobj.open('GET', file, true); // Replace 'my_data' with the path to your file
	    xobj.onreadystatechange = function () {
	          if (xobj.readyState == 4 && xobj.status == "200") {
	            // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
	            callback(xobj.responseText);
	          }
	    };
	    xobj.send(null);  
	 }

	function match(c){
		if(!c || c.length > 1) return;
		console.log(c);
		loadJSON("data/p2.json", function(response) {
	        var p_obj = JSON.parse(response);
	        for(var p of p_obj){
	        	var content = p.d_poetry.trunkTitle();
	        	var sentenses = content.split('。');
	        	// console.log(sentenses);
	        	for(sentense of sentenses){
	        		if(sentense.includes(c)){
		        		// console.log(content);
		        		res.push({
		        			sentense:sentense,
		        			poem:p
		        		});
		        	}
	        	}
	        }
	        // console.log(`found ${res.length} results`);
	        showButton.style.visibility = 'visible';
	        var len = res.length;
	        return render(res[Math.floor(Math.random()*len)]);
	    });
	}

	function refreshPoem(){
		if(res.length < 1) return;
		var len = res.length;
		return render(res[Math.floor(Math.random()*len)]);
	}

	function highlight(s,c){
		var splitArray = s.trim().split(c);
		var res = splitArray.join("<span class = 'red'>"+c+"</span>");
		return res;
	}

	String.prototype.trunkTitle = function(){
		var index = this.indexOf('】');
		return this.slice(index+1).trim();
	}

	String.prototype.trunkNote = function(){
		var arr = this.split('');
		var transformArray = arr.filter(function(c){
			return (c !== '[' && c !== ']' && isNaN(parseInt(c)));
		})
		return transformArray.join('');
	}

	String.prototype.recoverSentense = function(){
		return this+'。';
	}

	String.prototype.formatLine = function(){
		var splitArray = this.trim().split('\n').map(function(item){
			return '<p>'+item+'</p>'
		});
		var res = splitArray.join("");

		return res;
	}

	function render(obj){
		if(!obj){
			res_div.style.display = 'none';
		}else{
			res_div.style.display = 'block';
			title_p.textContent = obj.poem.d_title;
			author_p.textContent = obj.poem.d_author;
			content_p.innerHTML = highlight(obj.sentense.trunkNote().recoverSentense(),userInput.value);
			// console.log(obj.poem.d_poetry.trunkTitle());
			full_p.innerHTML = obj.poem.d_poetry.trunkTitle().trunkNote().formatLine();
			var els = document.querySelectorAll(".red");
			if(els){
				for(el of els){
					el.style.color = 'red';
				}
			}
		}
	}

	searchButtonStream.subscribe(function(){
		res = [];
		match(userInput.value);
	})

	refreshClickStream.subscribe(function(){
		full_p.style.display = "none";
		showButton.innerHTML = '<i class="fa fa-toggle-off" aria-hidden="true"></i>';
		refreshPoem();
	})

</script>
<script>if(!image_urls){var image_urls=Array()}if(!flash_urls){var flash_urls=Array()}image_urls['rain1']="http://2.bp.blogspot.com/-IQXNv-_CBLE/TpWcK7LL4VI/AAAAAAAAG0I/bcxYcqc_uI0/pinkpetal1.png";image_urls['rain2']="http://4.bp.blogspot.com/-teXCIicWPF4/TpWcLLg0A2I/AAAAAAAAG0U/IPPCr1gponc/pinkpetal2.png";image_urls['rain3']="http://3.bp.blogspot.com/-3JG9HLECCRU/TpWcLZGSYtI/AAAAAAAAG0g/zIJINua93TE/redpetal1.png";image_urls['rain4']="http://2.bp.blogspot.com/-BByhQEK5E24/TpWcLux4xRI/AAAAAAAAG0s/x2hIr1AV_Ac/redpetal2.png";$(document).ready(function(){var c=$(window).width();var
d=$(window).height();var e=function(a,b){return Math.round(a+(Math.random()*(b-a)))};var f=function(a){setTimeout(function(){a.css({left:e(0,c)+'px',top:'-30px',display:'block',opacity:'0.'+e(10,100)}).animate({top:(d-10)+'px'},e(7500,8000),function(){$(this).fadeOut('slow',function(){f(a)})})},e(1,8000))};$('<div></div>').attr('id','rainDiv')
.css({position:'fixed',width:(c-20)+'px',height:'1px',left:'0px',top:'-5px',display:'block'}).appendTo('body');for(var i=1;i<=20;i++){var g=$('<img/>').attr('src',image_urls['rain'+e(1,4)])
.css({position:'absolute',left:e(0,c)+'px',top:'-30px',display:'block',opacity:'0.'+e(10,100),'margin-left':0}).addClass('rainDrop').appendTo('#rainDiv');f(g);g=null};var h=0;var j=0;$(window).resize(function(){c=$(window).width();d=$(window).height()})});</script>

</body>
</html>