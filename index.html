<html>
<head>
	<title>flyflower</title>
	<meta charset="utf-8" />
	<link rel="stylesheet" type="text/css" href="basic.css">
</head>
<body>
	<div class = 'container'>
		<div class="header">
                 <h2>飞花令</h2>
                 <p>
		            Author: <a href="https://github.com/xinyzhang9">Xinyang</a> | Github: <a href = 'https://github.com/xinyzhang9/flyflower'>source code</a>      
		        </p>
        </div>
        <hr />
        
    	<input type = 'text' id = 'userinput'></input>
    	<button id = 'search'>search</button>
    	<button id = 'refresh'>refresh</button>
        <div id = 'res'>
        	<p id = 'title'></p>
        	<p id = 'author'></p>
        	<p id = 'content'></p>
        </div>
		

	</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/5.0.1/Rx.min.js"></script>

<script type="text/javascript">
	var refreshButton = document.getElementById('refresh');
	var userInput = document.getElementById('userinput');
	var searchButton = document.getElementById('search');

	var res_div = document.getElementById('res');
	var title_p = document.getElementById('title');
	var content_p = document.getElementById('content');
	var author_p = document.getElementById('author');

	var refreshClickStream = Rx.Observable.fromEvent(refreshButton, 'click');
	var searchButtonStream = Rx.Observable.fromEvent(searchButton,'click');

	Storage.prototype.setObj = function(key, obj) {
	    return this.setItem(key, JSON.stringify(obj))
	}
	Storage.prototype.getObj = function(key) {
	    return JSON.parse(this.getItem(key))
	}

	var res = [];

	function loadJSON(file, callback) {   
	    var xobj = new XMLHttpRequest();
	    xobj.overrideMimeType("application/json");
	    xobj.open('GET', file, true); // Replace 'my_data' with the path to your file
	    xobj.onreadystatechange = function () {
	          if (xobj.readyState == 4 && xobj.status == "200") {
	            // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
	            callback(xobj.responseText);
	          }
	    };
	    xobj.send(null);  
	 }

	// function load() {
	//     loadJSON("data/poetry.json", function(response) {
	//         p_obj = JSON.parse(response);
	//         console.log(`loaded ${p_obj.length} poems`);
	//         return p_obj;
	//     });
	// }

	function match(c){
		console.log(c);
		loadJSON("data/poetry.json", function(response) {
	        p_obj = JSON.parse(response);
	        for(var p of p_obj){
	        	var content = p.d_poetry;
	        	if(content.indexOf(c) >= 0){
	        		// console.log(content);
	        		res.push(p);
	        	}
	        }
	        return render(res[0]);
	    });
	}

	function refreshPoem(){
		if(res.length < 1) return;
		var len = res.length;
		var chosen = res[Math.floor(Math.random()*len)];
		return render(chosen);
	}

	function highlight(s,c){
		var splitArray = s.trim().split(c);
		var tramsformArray = splitArray.map(function(item){
			return "<span class = 'normal'>"+item+"</span>"
		});

		var res = tramsformArray.join("<span class = 'red'>"+c+"</span>");
		return res;

	}

	String.prototype.trunkTitle = function(){
		var index = this.indexOf('】');
		return this.slice(index+1).trim();
	}

	String.prototype.trunkNote = function(){
		var arr = this.split('');
		var transformArray = arr.filter(function(c){
			return (c !== '[' && c !== ']' && isNaN(parseInt(c)));
		})
		return transformArray.join('');
	}

	function render(poem){
		if(poem === null){
			res_div.style.visibility = 'hidden';
		}else{
			console.log(poem.d_poetry);
			res_div.style.visibility = 'visible';
			title_p.textContent = poem.d_title;
			// content_p.textContent = poem.d_poetry;
			content_p.innerHTML = highlight(poem.d_poetry.trunkTitle().trunkNote(),userInput.value);
			author_p.textContent = poem.d_author;
			var els = document.querySelectorAll(".red");
			if(els){
				for(el of els){
					el.style.color = 'red';
				}
			}
		}
	}

	searchButtonStream.subscribe(function(){
		match(userInput.value);
	})

	refreshClickStream.subscribe(function(){
		refreshPoem();
	})

</script>
</body>
</html>